---
title: java虚拟机笔记（三）
date: 2018-08-11 08:55:58
tags:
- java
- jvm
- 虚拟机
- 读书笔记
category:
- 技术文章
---

# 虚拟机类加载机制

### 类加载时机

​	类从被加载到虚拟机内存开始到卸载内存为止，整个生命周期包括：**加载、验证、准备、解析、初始化、使用和卸载**

​	类必须立即初始化情况：

1. 遇到 new、getstatic、putstatic和invokestatic这4条字节码指令时。
2. 使用java.lang.reflect包方法对类进行反射调用时候。
3. 当初始化一个类的时候，欺父类没有被初始化要先初始化其父类。
4. 虚拟机启动时用户需要指定要执行的主类（包括main方法），虚拟机会先初始化这个主类。
5. 如果一个java.lang.reflect.MethodHandle实例最后的解析结果是REF_getStatic、REF_putStatic、REF_invokeStatic的方法句柄，并且这个方法句柄所对应的类没有初始化，则先触发其初始化。

### 类加载过程

###### 加载

1. 通过一个类的全限定名获取此类的二进制字节流。
2. 将这个字节流所代表的的静态存储结构转换成方法区的运行时数据结构。
3. 在内存生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问接口。

###### 验证

​	是连接阶段的第一步，这个阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并不会危害虚拟机的自身安全。

* 文件格式验证

  第一阶段验证字节流是否符合Class文件格式规范，并能被当前版本虚拟机处理。

* 云数据验证

  第二阶段对字节码描述的信息进行语义分析，确保描述信息符合Java语言要求规范。

* 字节码验证

  第三阶段对类的方法体进行校验分析，保证被校验的方法在运行时不会出现危害虚拟机的安全事件。

* 符号引用验证

  对类自身以外（常量池中的各种符号引用）的信息进行匹配校验。

###### 准备

​	正式为变量分配内存并设置初始值的阶段，这些变量使用的内存将在方法区中分配。仅包括类变量（被static修饰）不包括实例变量。赋初值是指数据类型的零值。

###### 解析

​	将常量池中的符号引用替换为直接引用。

* 符号引用：以一组符号来描述所引用的目标，符号可以是任何形式的字面量。
* 直接引用：可以直接指向目标的指针、相对偏移量或能间接的定位到目标的句柄。

###### 初始化

执行类中定义的Java程序代码，初始化阶段是执行类构造器（\<clinit>()）方法的过程。

### 类加载器

启动类加载器、扩展类加载器、应用程序类加载器。

#### 双亲委派模型

![双亲委派模型](https://raw.githubusercontent.com/lgsdaredevil/newblog/resource-newblog/source/favicons/article/%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B.jpg)

双亲委派模型要求除了顶层的启动类加载器外，其余的类加载器都应当有自己的父类加载器。这里的类加载器的父子关系一般是组合关系来复用父加载器的代码。

​	工作过程：如果一个类加载器收到类加载请求，首先会把这个请求为派给父类加载器去完成，每一层的类加载器都是这样的，因此所有请求都传给顶层的启动类加载器，只有当父类加载器反馈无法完成加载请求，子类才会尝试自己加载。



